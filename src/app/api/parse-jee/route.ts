import { NextRequest, NextResponse } from "next/server";

// ─────────────────────────────────────────────
//  PASTE YOUR ANSWER KEY HERE
// ─────────────────────────────────────────────
const OFFICIAL_ANSWER_KEY: Record<string, string | number> = {
 "8606541126": "8606543827",
  "8606541127": "8606543832",
  "8606541128": "8606543834",
  "8606541129": "8606543839",
  "8606541130": "8606543844",
  "8606541131": "8606543849",
  "8606541132": "8606543851",
  "8606541133": "8606543854",
  "8606541134": "8606543861",
  "8606541135": "8606543864",
  "8606541136": "8606543867",
  "8606541137": "8606543872",
  "8606541138": "8606543875",
  "8606541139": "8606543880",
  "8606541140": "8606543883",
  "8606541141": "8606543886",
  "8606541142": "8606543891",
  "8606541143": "8606543895",
  "8606541144": "8606543899",
  "8606541145": "8606543903",
  "8606541146": 225,
  "8606541147": 2,
  "8606541148": 1333,
  "8606541149": 1,
  "8606541150": 17,
  "8606541151": "8606543912",
  "8606541152": "8606543916",
  "8606541153": "8606543922",
  "8606541154": "8606543923",
  "8606541155": "8606543930",
  "8606541156": "8606543933",
  "8606541157": "8606543936",
  "8606541158": "8606543940",
  "8606541159": "8606543946",
  "8606541160": "8606543947",
  "8606541161": "8606543953",
  "8606541162": "8606543955",
  "8606541163": "8606543959",
  "8606541164": "8606543966",
  "8606541165": "8606543969",
  "8606541166": "8606543974",
  "8606541167": "8606543978",
  "8606541168": "8606543980",
  "8606541169": "8606543986",
  "8606541170": "8606543988",
  "8606541171": 17,
  "8606541172": 280,
  "8606541173": 100,
  "8606541174": 1080,
  "8606541175": 500,
  "8606541176": "8606543997",
  "8606541177": "8606544002",
  "8606541178": "8606544007",
  "8606541179": "8606544008",
  "8606541180": "8606544014",
  "8606541181": "8606544018",
  "8606541182": "8606544022",
  "8606541183": "8606544026",
  "8606541184": "8606544028",
  "8606541185": "8606544034",
  "8606541186": "8606544038",
  "8606541187": "8606544041",
  "8606541188": "8606544047",
  "8606541189": "8606544051",
  "8606541190": "8606544053",
  "8606541191": "8606544059",
  "8606541192": "8606544062",
  "8606541193": "8606544067",
  "8606541194": "8606544069",
  "8606541195": "8606544073",
  "8606541196": 20,
  "8606541197": 13,
  "8606541198": 70,
  "8606541199": 6,
  "8606541200": 8,
  "860654826": "8606542808",
  "860654827": "8606542812",
  "860654828": "8606542814",
  "860654829": "8606542820",
  "860654830": "8606542824",
  "860654831": "8606542828",
  "860654832": "8606542830",
  "860654833": "8606542837",
  "860654834": "8606542840",
  "860654835": "8606542842",
  "860654836": "8606542847",
  "860654837": "8606542853",
  "860654838": "8606542856",
  "860654839": "8606542859",
  "860654840": "8606542864",
  "860654841": "8606542866",
  "860654842": "8606542873",
  "860654843": "8606542877",
  "860654844": "8606542881",
  "860654845": "8606542883",
  "860654846": 32,
  "860654847": 2,
  "860654848": 65,
  "860654849": 2,
  "860654850": 9,
  "860654851": "8606542892",
  "860654852": "8606542898",
  "860654853": "8606542900",
  "860654854": "8606542904",
  "860654855": "8606542907",
  "860654856": "8606542911",
  "860654857": "8606542916",
  "860654858": "8606542922",
  "860654859": "8606542924",
  "860654860": "8606542929",
  "860654861": "8606542934",
  "860654862": "8606542937",
  "860654863": "8606542939",
  "860654864": "8606542944",
  "860654865": "8606542948",
  "860654866": "8606542952",
  "860654867": "8606542958",
  "860654868": "8606542960",
  "860654869": "8606542963",
  "860654870": "8606542968",
  "860654871": 5,
  "860654872": 350,
  "860654873": 1800,
  "860654874": 14,
  "860654875": 10,
  "860654876": "8606542978",
  "860654877": "8606542981",
  "860654878": "8606542985",
  "860654879": "8606542989",
  "860654880": "8606542995",
  "860654881": "8606542998",
  "860654882": "8606543003",
  "860654883": "8606543006",
  "860654884": "8606543009",
  "860654885": "8606543012",
  "860654886": "8606543019",
  "860654887": "8606543020",
  "860654888": "8606543024",
  "860654889": "8606543031",
  "860654890": "8606543032",
  "860654891": "8606543036",
  "860654892": "8606543042",
  "860654893": "8606543045",
  "860654894": "8606543048",
  "860654895": "8606543053",
  "860654896": 3,
  "860654897": 15,
  "860654898": 100,
  "860654899": 200,
  "860654900": 7,
  "444792151": "444792511",
  "444792152": "444792518",
  "444792153": "444792520",
  "444792154": "444792524",
  "444792155": "444792528",
  "444792156": "444792533",
  "444792157": "444792535",
  "444792158": "444792542",
  "444792159": "444792546",
  "444792160": "444792549",
  "444792161": "444792551",
  "444792162": "444792556",
  "444792163": "444792560",
  "444792164": "444792566",
  "444792165": "444792570",
  "444792166": "444792572",
  "444792167": "444792576",
  "444792168": "444792581",
  "444792169": "444792585",
  "444792170": "444792587",
  "444792171": 49,
  "444792172": 18,
  "444792173": 660,
  "444792174": 4,
  "444792175": 16,
  "444792176": "444792598",
  "444792177": "444792601",
  "444792178": "444792606",
  "444792179": "444792610",
  "444792180": "444792613",
  "444792181": "444792616",
  "444792182": "444792622",
  "444792183": "444792627",
  "444792184": "444792629",
  "444792185": "444792634",
  "444792186": "444792636",
  "444792187": "444792642",
  "444792188": "444792645",
  "444792189": "444792651",
  "444792190": "444792654",
  "444792192": "444792660",
  "444792193": "444792667",
  "444792194": "444792669",
  "444792195": "444792673",
  "444792196": 16,
  "444792197": 600,
  "444792198": 20,
  "444792199": 4,
  "444792200": 100,
  "444792201": "444792684",
  "444792202": "444792686",
  "444792203": "444792689",
  "444792204": "444792693",
  "444792205": "444792699",
  "444792206": "444792703",
  "444792207": "444792707",
  "444792208": "444792710",
  "444792209": "444792716",
  "444792210": "444792718",
  "444792211": "444792723",
  "444792212": "444792728",
  "444792213": "444792732",
  "444792214": "444792735",
  "444792215": "444792740",
  "444792216": "444792744",
  "444792217": "444792745",
  "444792218": "444792750",
  "444792219": "444792754",
  "444792220": "444792759",
  "444792221": 33,
  "444792222": 4,
  "444792223": 1303,
  "444792224": 66,
  "444792225": 43,
  "860654976": "8606543317",
  "860654977": "8606543321",
  "860654978": "8606543325",
  "860654979": "8606543329",
  "860654980": "8606543333",
  "860654981": "8606543338",
  "860654982": "8606543342",
  "860654983": "8606543346",
  "860654984": "8606543348",
  "860654985": "8606543353",
  "860654986": "8606543357",
  "860654987": "8606543360",
  "860654988": "8606543364",
  "860654989": "8606543371",
  "860654990": "8606543374",
  "860654991": "8606543377",
  "860654992": "8606543382",
  "860654993": "8606543385",
  "860654994": "8606543389",
  "860654995": "8606543392",
  "860654996": 9,
  "860654997": 1979,
  "860654998": 20,
  "860654999": 5,
  "8606541000": 36,
  "8606541001": "8606543401",
  "8606541002": "8606543405",
  "8606541003": "8606543410",
  "8606541004": "8606543415",
  "8606541005": "8606543417",
  "8606541006": "8606543421",
  "8606541007": "8606543425",
  "8606541008": "8606543429",
  "8606541009": "8606543433",
  "8606541010": "8606543438",
  "8606541011": "8606543442",
  "8606541012": "8606543447",
  "8606541013": "8606543452",
  "8606541014": "8606543455",
  "8606541015": "8606543457",
  "8606541016": "8606543464",
  "8606541017": "8606543465",
  "8606541018": "8606543472",
  "8606541019": "8606543476",
  "8606541020": "8606543479",
  "8606541021": 2,
  "8606541022": 4,
  "8606541023": 1,
  "8606541024": 7,
  "8606541025": 14,
  "8606541026": "8606543487",
  "8606541027": "8606543491",
  "8606541028": "8606543497",
  "8606541029": "8606543500",
  "8606541030": "8606543503",
  "8606541031": "8606543508",
  "8606541032": "8606543511",
  "8606541033": "8606543514",
  "8606541034": "8606543520",
  "8606541035": "8606543524",
  "8606541036": "8606543526",
  "8606541037": "8606543532",
  "8606541038": "8606543536",
  "8606541039": "8606543539",
  "8606541040": "8606543543",
  "8606541041": "8606543547",
  "8606541042": "8606543550",
  "8606541043": "8606543557",
  "8606541044": "8606543561",
  "8606541045": "8606543562",
  "8606541046": 1031,
  "8606541047": 4,
  "8606541048": 57,
  "8606541049": 3,
  "8606541050": 10,
  "8606541351": "8606544593",
  "8606541352": "8606544597",
  "8606541353": "8606544601",
  "8606541354": "8606544604",
  "8606541355": "8606544608",
  "8606541356": "8606544613",
  "8606541357": "8606544616",
  "8606541358": "8606544621",
  "8606541359": "8606544626",
  "8606541360": "8606544628",
  "8606541361": "8606544631",
  "8606541362": "8606544636",
  "8606541363": "8606544642",
  "8606541364": "8606544644",
  "8606541365": "8606544650",
  "8606541366": "8606544654",
  "8606541367": "8606544656",
  "8606541368": "8606544660",
  "8606541369": "8606544665",
  "8606541370": "8606544667",
  "8606541371": 62,
  "8606541372": 1422,
  "8606541373": 311,
  "8606541374": 1565,
  "8606541375": 12,
  "8606541376": "8606544678",
  "8606541377": "8606544682",
  "8606541378": "8606544686",
  "8606541379": "8606544688",
  "8606541380": "8606544693",
  "8606541381": "8606544697",
  "8606541382": "8606544702",
  "8606541383": "8606544705",
  "8606541384": "8606544709",
  "8606541385": "8606544713",
  "8606541386": "8606544717",
  "8606541387": "8606544721",
  "8606541388": "8606544725",
  "8606541389": "8606544731",
  "8606541390": "8606544733",
  "8606541391": "8606544736",
  "8606541392": "8606544741",
  "8606541393": "8606544746",
  "8606541394": "8606544750",
  "8606541396": 50,
  "8606541397": 4,
  "8606541398": 2,
  "8606541399": 100,
  "8606541400": 8,
  "8606541401": "8606544764",
  "8606541402": "8606544767",
  "8606541403": "8606544770",
  "8606541404": "8606544773",
  "8606541405": "8606544777",
  "8606541406": "8606544781",
  "8606541407": "8606544788",
  "8606541408": "8606544790",
  "8606541409": "8606544795",
  "8606541410": "8606544799",
  "8606541411": "8606544801",
  "8606541412": "8606544807",
  "8606541413": "8606544810",
  "8606541414": "8606544816",
  "8606541415": "8606544818",
  "8606541416": "8606544823",
  "8606541417": "8606544825",
  "8606541418": "8606544829",
  "8606541419": "8606544834",
  "8606541420": "8606544840",
  "8606541421": 1825,
  "8606541422": 125,
  "8606541423": 10,
  "8606541424": 2,
  "8606541425": 3,
  "444792451": "4447921534",
  "444792452": "4447921536",
  "444792453": "4447921539",
  "444792454": "4447921546",
  "444792455": "4447921549",
  "444792456": "4447921552",
  "444792457": "4447921557",
  "444792458": "4447921559",
  "444792459": "4447921564",
  "444792460": "4447921568",
  "444792461": "4447921574",
  "444792462": "4447921575",
  "444792463": "4447921581",
  "444792464": "4447921584",
  "444792465": "4447921590",
  "444792466": "4447921592",
  "444792467": "4447921597",
  "444792468": "4447921600",
  "444792469": "4447921606",
  "444792470": "4447921608",
  "444792471": 3,
  "444792472": 260,
  "444792473": 3,
  "444792474": 16,
  "444792475": 16,
  "444792476": "4447921617",
  "444792477": "4447921622",
  "444792478": "4447921624",
  "444792479": "4447921628",
  "444792480": "4447921632",
  "444792481": "4447921638",
  "444792482": "4447921643",
  "444792483": "4447921645",
  "444792484": "4447921648",
  "444792485": "4447921655",
  "444792486": "4447921658",
  "444792487": "4447921662",
  "444792488": "4447921665",
  "444792489": "4447921670",
  "444792490": "4447921672",
  "444792491": "4447921679",
  "444792492": "4447921680",
  "444792494": "4447921690",
  "444792495": "4447921694",
  "444792496": 109,
  "444792497": 1,
  "444792498": 819,
  "444792499": 16,
  "444792500": 228,
  "444792501": "4447921701",
  "444792502": "4447921706",
  "444792503": "4447921709",
  "444792504": "4447921713",
  "444792505": "4447921719",
  "444792506": "4447921723",
  "444792507": "4447921725",
  "444792508": "4447921729",
  "444792509": "4447921735",
  "444792510": "4447921740",
  "444792511": "4447921742",
  "444792512": "4447921747",
  "444792513": "4447921751",
  "444792514": "4447921754",
  "444792515": "4447921760",
  "444792516": "4447921763",
  "444792517": "4447921765",
  "444792518": "4447921771",
  "444792519": "4447921773",
  "444792520": "4447921779",
  "444792521": 2,
  "444792522": 10,
  "444792523": 375,
  "444792524": 15,
  "444792525": 200,
  "444792526": "4447921787",
  "444792527": "4447921790",
  "444792528": "4447921794",
  "444792529": "4447921798",
  "444792530": "4447921803",
  "444792531": "4447921807",
  "444792532": "4447921810",
  "444792533": "4447921817",
  "444792534": "4447921818",
  "444792535": "4447921824",
  "444792536": "4447921828",
  "444792537": "4447921833",
  "444792538": "4447921836",
  "444792539": "4447921841",
  "444792540": "4447921842",
  "444792541": "4447921849",
  "444792542": "4447921852",
  "444792543": "4447921856",
  "444792544": "4447921859",
  "444792545": "4447921863",
  "444792546": 312,
  "444792547": 42,
  "444792548": 6,
  "444792549": 4,
  "444792550": 64,
  "444792551": "4447921874",
  "444792552": "4447921877",
  "444792553": "4447921880",
  "444792554": "4447921886",
  "444792555": "4447921887",
  "444792556": "4447921892",
  "444792557": "4447921897",
  "444792558": "4447921900",
  "444792559": "4447921903",
  "444792560": "4447921907",
  "444792561": "4447921913",
  "444792562": "4447921916",
  "444792563": "4447921920",
  "444792564": "4447921923",
  "444792565": "4447921928",
  "444792566": "4447921931",
  "444792567": "4447921936",
  "444792568": "4447921941",
  "444792569": "4447921946",
  "444792570": "4447921949",
  "444792571": 125,
  "444792572": 210,
  "444792573": 160,
  "444792574": 3730,
  "444792575": 64,
  "444792576": "4447921958",
  "444792577": "4447921961",
  "444792578": "4447921965",
  "444792579": "4447921971",
  "444792580": "4447921974",
  "444792581": "4447921977",
  "444792582": "4447921981",
  "444792583": "4447921986",
  "444792584": "4447921991",
  "444792585": "4447921992",
  "444792586": "4447921996",
  "444792587": "4447922002",
  "444792588": "4447922004",
  "444792589": "4447922010",
  "444792590": "4447922014",
  "444792591": "4447922017",
  "444792592": "4447922020",
  "444792593": "4447922025",
  "444792594": "4447922031",
  "444792595": "4447922033",
  "444792596": 12,
  "444792597": 15,
  "444792598": 54,
  "444792599": 4,
  "444792600": 111,
  "444792601": "4447922043",
  "444792602": "4447922047",
  "444792603": "4447922050",
  "444792604": "4447922053",
  "444792605": "4447922060",
  "444792606": "4447922063",
  "444792607": "4447922067",
  "444792608": "4447922071",
  "444792609": "4447922074",
  "444792610": "4447922078",
  "444792611": "4447922082",
  "444792612": "4447922086",
  "444792613": "4447922089",
  "444792614": "4447922096",
  "444792615": "4447922099",
  "444792616": "4447922101",
  "444792617": "4447922107",
  "444792618": "4447922112",
  "444792619": "4447922113",
  "444792620": "4447922117",
  "444792621": 5,
  "444792622": 15,
  "444792623": 9,
  "444792624": 4,
  "444792625": 2,
  "444792626": "4447922127",
  "444792627": "4447922132",
  "444792628": "4447922136",
  "444792629": "4447922138",
  "444792630": "4447922144",
  "444792631": "4447922147",
  "444792632": "4447922151",
  "444792633": "4447922154",
  "444792634": "4447922161",
  "444792635": "4447922163",
  "444792636": "4447922168",
  "444792637": "4447922170",
  "444792638": "4447922177",
  "444792639": "4447922179",
  "444792640": "4447922183",
  "444792641": "4447922188",
  "444792642": "4447922191",
  "444792643": "4447922195",
  "444792644": "4447922200",
  "444792645": "4447922202",
  "444792646": 90,
  "444792647": 481,
  "444792648": 11304,
  "444792649": 162,
  "444792650": 6,
  "444792651": "4447922212",
  "444792652": "4447922216",
  "444792653": "4447922222",
  "444792654": "4447922223",
  "444792655": "4447922227",
  "444792656": "4447922233",
  "444792657": "4447922236",
  "444792658": "4447922242",
  "444792659": "4447922245",
  "444792660": "4447922247",
  "444792661": "4447922253",
  "444792662": "4447922255",
  "444792663": "4447922259",
  "444792664": "4447922264",
  "444792665": "4447922268",
  "444792666": "4447922272",
  "444792667": "4447922275",
  "444792668": "4447922282",
  "444792669": "4447922285",
  "444792670": "4447922289",
  "444792671": 3,
  "444792672": 6,
  "444792673": 73,
  "444792674": 2,
  "444792675": 102,
  "444792676": "4447922297",
  "444792677": "4447922302",
  "444792678": "4447922306",
  "444792679": "4447922310",
  "444792680": "4447922312",
  "444792681": "4447922317",
  "444792682": "4447922321",
  "444792683": "4447922326",
  "444792684": "4447922328",
  "444792685": "4447922334",
  "444792686": "4447922337",
  "444792687": "4447922342",
  "444792688": "4447922344",
  "444792689": "4447922350",
  "444792690": "4447922354",
  "444792691": "4447922357",
  "444792692": "4447922361",
  "444792693": "4447922364",
  "444792694": "4447922370",
  "444792695": "4447922373",
  "444792696": 90,
  "444792697": 1,
  "444792698": 37,
  "444792699": 210,
  "444792700": 8,
  "444792701": "4447922383",
  "444792702": "4447922386",
  "444792703": "4447922390",
  "444792704": "4447922393",
  "444792705": "4447922399",
  "444792706": "4447922403",
  "444792707": "4447922408",
  "444792708": "4447922412",
  "444792709": "4447922414",
  "444792710": "4447922417",
  "444792711": "4447922421",
  "444792712": "4447922427",
  "444792713": "4447922431",
  "444792714": "4447922436",
  "444792715": "4447922440",
  "444792716": "4447922441",
  "444792717": "4447922447",
  "444792718": "4447922449",
  "444792719": "4447922455",
  "444792720": "4447922460",
  "444792721": 3,
  "444792722": 21,
  "444792723": 2,
  "444792724": 265,
  "444792725": 2,
  "444792726": "4447922467",
  "444792727": "4447922472",
  "444792728": "4447922475",
  "444792729": "4447922480",
  "444792730": "4447922483",
  "444792731": "4447922489",
  "444792732": "4447922491",
  "444792733": "4447922495",
  "444792734": "4447922501",
  "444792735": "4447922502",
  "444792736": "4447922507",
  "444792737": "4447922512",
  "444792738": "4447922517",
  "444792739": "4447922520",
  "444792740": "4447922522",
  "444792741": "4447922529",
  "444792742": "4447922531",
  "444792743": "4447922537",
  "444792744": "4447922538",
  "444792745": "4447922542",
  "444792746": 6,
  "444792747": 4,
  "444792748": 3,
  "444792749": 24,
  "444792750": 3,
  "8606541651": "8606545611",
  "8606541652": "8606545615",
  "8606541653": "8606545621",
  "8606541654": "8606545625",
  "8606541655": "8606545630",
  "8606541656": "8606545632",
  "8606541657": "8606545635",
  "8606541658": "8606545641",
  "8606541659": "8606545646",
  "8606541660": "8606545648",
  "8606541661": "8606545652",
  "8606541662": "8606545658",
  "8606541663": "8606545661",
  "8606541664": "8606545665",
  "8606541665": "8606545670",
  "8606541666": "8606545674",
  "8606541667": "8606545677",
  "8606541668": "8606545681",
  "8606541669": "8606545683",
  "8606541670": "8606545689",
  "8606541671": 0,
  "8606541672": 976,
  "8606541673": 210,
  "8606541674": 170,
  "8606541675": 9,
  "8606541676": "8606545699",
  "8606541677": "8606545700",
  "8606541678": "8606545705",
  "8606541679": "8606545708",
  "8606541680": "8606545714",
  "8606541681": "8606545718",
  "8606541682": "8606545720",
  "8606541683": "8606545725",
  "8606541684": "8606545729",
  "8606541685": "8606545733",
  "8606541686": "8606545739",
  "8606541687": "8606545743",
  "8606541688": "8606545745",
  "8606541689": "8606545749",
  "8606541690": "8606545752",
  "8606541691": "8606545759",
  "8606541692": "8606545761",
  "8606541693": "8606545766",
  "8606541694": "8606545768",
  "8606541695": "8606545774",
  "8606541696": 30,
  "8606541697": 384,
  "8606541698": 314,
  "8606541699": 300,
  "8606541700": 429,
  "8606541701": "8606545782",
  "8606541702": "8606545787",
  "8606541703": "8606545792",
  "8606541704": "8606545793",
  "8606541705": "8606545797",
  "8606541706": "8606545804",
  "8606541707": "8606545807",
  "8606541708": "8606545809",
  "8606541709": "8606545816",
  "8606541710": "8606545820",
  "8606541711": "8606545822",
  "8606541712": "8606545828",
  "8606541713": "8606545831",
  "8606541714": "8606545835",
  "8606541715": "8606545837",
  "8606541716": "8606545843",
  "8606541717": "8606545848",
  "8606541718": "8606545850",
  "8606541719": "8606545854",
  "8606541720": "8606545860",
  "8606541721": 2,
  "8606541722": 4,
  "8606541723": 78,
  "8606541724": 5,
  "8606541725": 6,
};


const MARKS_CORRECT = 4;
const MARKS_WRONG   = -1;

const SECTION_MAP: Record<string, string[]> = {
  Physics:     ["Physics Section A",     "Physics Section B"],
  Chemistry:   ["Chemistry Section A",   "Chemistry Section B"],
  Mathematics: ["Mathematics Section A", "Mathematics Section B"],
};

// ─────────────────────────────────────────────
//  HTML HELPERS  (zero deps — pure regex/string)
// ─────────────────────────────────────────────

/** Strip all HTML tags and decode common entities */
function textContent(html: string): string {
  return html
    .replace(/<[^>]+>/g, " ")
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&#(\d+);/g, (_, n) => String.fromCharCode(Number(n)))
    .replace(/\s+/g, " ")
    .trim();
}

/** Extract all <td>…</td> text values from an HTML string */
function getTdTexts(html: string): string[] {
  const results: string[] = [];
  const re = /<td[^>]*>([\s\S]*?)<\/td>/gi;
  let m;
  while ((m = re.exec(html)) !== null) {
    results.push(textContent(m[1]));
  }
  return results;
}

// ─────────────────────────────────────────────
//  PARSER  — handles BOTH formats:
//  1. digialm CDN format (flat tables, no special divs)
//  2. Classic NTA format (section-cntnr / question-pnl divs)
// ─────────────────────────────────────────────

interface Question {
  section:          string;
  question_id:      string | null;
  question_type:    string | null;
  candidate_answer: string | null;
  is_attempted:     boolean;
}

function parseJEEHtml(html: string): {
  candidateInfo: Record<string, string>;
  questions: Question[];
} {
  const candidateInfo: Record<string, string> = {};
  const CANDIDATE_KEYS = [
    "Application No", "Candidate Name", "Roll No.",
    "Test Date", "Test Time", "Subject",
  ];

  // ── Candidate info: scan ALL td pairs in the whole doc ──
  const allTds = getTdTexts(html);
  for (let i = 0; i + 1 < allTds.length; i++) {
    const k = allTds[i].replace(/:$/, "").trim();
    if (CANDIDATE_KEYS.includes(k)) {
      candidateInfo[k] = allTds[i + 1].trim();
    }
  }

  const questions: Question[] = [];

  // ── Detect format ──
  const hasClassDivs = /class="[^"]*section-cntnr[^"]*"/.test(html);

  if (hasClassDivs) {
    // ── FORMAT 1: Classic section-cntnr / question-pnl divs ──
    const sectionRe = /<div[^>]+class="[^"]*section-cntnr[^"]*"[^>]*>/gi;
    const sectionStarts: number[] = [];
    let sm;
    while ((sm = sectionRe.exec(html)) !== null) sectionStarts.push(sm.index);

    for (let si = 0; si < sectionStarts.length; si++) {
      const sectionChunk = html.slice(
        sectionStarts[si],
        sectionStarts[si + 1] ?? html.length
      );

      // Section name
      const lblMatch = sectionChunk.match(
        /class="[^"]*section-lbl[^"]*"[^>]*>([\s\S]*?)<\/div>/i
      );
      const sectionName = lblMatch
        ? textContent(lblMatch[1]).replace(/Section\s*:/, "").trim()
        : "Unknown";

      // Question panels
      const qRe = /<div[^>]+class="[^"]*question-pnl[^"]*"[^>]*>/gi;
      const qStarts: number[] = [];
      let qm;
      while ((qm = qRe.exec(sectionChunk)) !== null) qStarts.push(qm.index);

      for (let qi = 0; qi < qStarts.length; qi++) {
        const qChunk = sectionChunk.slice(
          qStarts[qi],
          qStarts[qi + 1] ?? sectionChunk.length
        );
        const q = extractQuestionData(qChunk, sectionName);
        questions.push(q);
      }
    }
  } else {
    // ── FORMAT 2: digialm CDN flat tables ──
    // Sections are marked by text like "Section : Mathematics Section A"
    // Each question is a big <table> block

    // Split by section headers
    const sectionHeaderRe = /Section\s*:\s*([^\n<]+)/gi;
    const sectionMatches: Array<{ name: string; index: number }> = [];
    let shm;
    while ((shm = sectionHeaderRe.exec(html)) !== null) {
      sectionMatches.push({
        name:  shm[1].trim(),
        index: shm.index,
      });
    }

    if (sectionMatches.length === 0) {
      // Fallback: treat entire doc as one section
      sectionMatches.push({ name: "Unknown", index: 0 });
    }

    for (let si = 0; si < sectionMatches.length; si++) {
      const sectionName  = sectionMatches[si].name;
      const sectionStart = sectionMatches[si].index;
      const sectionEnd   = sectionMatches[si + 1]?.index ?? html.length;
      const sectionChunk = html.slice(sectionStart, sectionEnd);

      // Each question block is identified by "Question Type :" in a table
      // Split the section HTML into per-question chunks by finding table blocks
      // that contain "Question ID"
      const tableRe = /<table[\s\S]*?<\/table>/gi;
      let tm;
      while ((tm = tableRe.exec(sectionChunk)) !== null) {
        const tableHtml = tm[0];
        if (!tableHtml.includes("Question ID")) continue;

        const q = extractQuestionData(tableHtml, sectionName);
        if (q.question_id) questions.push(q);
      }
    }
  }

  return { candidateInfo, questions };
}

/** Extract question data from any HTML chunk containing the metadata table */
function extractQuestionData(chunk: string, sectionName: string): Question {
  const q: Question = {
    section:          sectionName,
    question_id:      null,
    question_type:    null,
    candidate_answer: null,
    is_attempted:     false,
  };

  const cells     = getTdTexts(chunk);
  const optionMap: Record<string, string> = {};

  for (let i = 0; i + 1 < cells.length; i++) {
    // Normalize key: remove trailing colon/spaces
    const key = cells[i].replace(/\s*:\s*$/, "").trim();
    const val = cells[i + 1].trim();

    if (key === "Question Type") {
      q.question_type = val;
    } else if (key === "Question ID") {
      q.question_id = val;
    } else if (/^Option\s+\d+\s+ID$/i.test(key)) {
      // "Option 1 ID", "Option 2 ID" etc.
      const idx = key.replace(/Option\s+/i, "").replace(/\s+ID$/i, "").trim();
      optionMap[idx] = val;
    } else if (key === "Chosen Option") {
      if (val !== "--" && val in optionMap) {
        q.candidate_answer = optionMap[val];
        q.is_attempted     = true;
      }
    } else if (key === "Given Answer") {
      if (val && val !== "--" && val !== "Not Answered") {
        q.candidate_answer = val;
        q.is_attempted     = true;
      }
    }
  }

  return q;
}

// ─────────────────────────────────────────────
//  SCORE CALCULATOR
// ─────────────────────────────────────────────
function calculateScores(questions: Question[]) {
  const subjects = ["Physics", "Chemistry", "Mathematics"] as const;
  type Subject = typeof subjects[number];

  const stats: Record<Subject, { correct: number; wrong: number; skipped: number; score: number }> =
    {} as never;
  for (const s of subjects) stats[s] = { correct: 0, wrong: 0, skipped: 0, score: 0 };

  for (const q of questions) {
    let subject: Subject | null = null;
    for (const [subj, subs] of Object.entries(SECTION_MAP)) {
      if (subs.includes(q.section)) { subject = subj as Subject; break; }
    }
    if (!subject) continue;

    const qid     = String(q.question_id  ?? "").trim();
    const candAns = String(q.candidate_answer ?? "").trim();

    if (!(qid in OFFICIAL_ANSWER_KEY)) { stats[subject].skipped++; continue; }

    const correct = String(OFFICIAL_ANSWER_KEY[qid]).trim();

    if (!q.is_attempted || !candAns || candAns === "None") {
      stats[subject].skipped++;
    } else if (candAns === correct) {
      stats[subject].correct++;
      stats[subject].score += MARKS_CORRECT;
    } else {
      stats[subject].wrong++;
      stats[subject].score += MARKS_WRONG;
    }
  }

  return {
    sections: subjects.map((subj) => ({
      name:        subj,
      correct:     stats[subj].correct,
      wrong:       stats[subj].wrong,
      unattempted: stats[subj].skipped,
      attempted:   stats[subj].correct + stats[subj].wrong,
      score:       stats[subj].score,
      total:       25,
    })),
    total_score:         subjects.reduce((s, sub) => s + stats[sub].score,   0),
    total_correct:       subjects.reduce((s, sub) => s + stats[sub].correct, 0),
    total_wrong:         subjects.reduce((s, sub) => s + stats[sub].wrong,   0),
    total_skipped:       subjects.reduce((s, sub) => s + stats[sub].skipped, 0),
    physics_correct:     stats.Physics.correct,
    physics_wrong:       stats.Physics.wrong,
    physics_skipped:     stats.Physics.skipped,
    chemistry_correct:   stats.Chemistry.correct,
    chemistry_wrong:     stats.Chemistry.wrong,
    chemistry_skipped:   stats.Chemistry.skipped,
    mathematics_correct: stats.Mathematics.correct,
    mathematics_wrong:   stats.Mathematics.wrong,
    mathematics_skipped: stats.Mathematics.skipped,
  };
}

// ─────────────────────────────────────────────
//  URL FETCHER
// ─────────────────────────────────────────────
const PROXIES = [
  (u: string) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  (u: string) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
  (u: string) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
];

async function fetchUrl(url: string): Promise<string> {
  try {
    const res = await fetch(url, {
      headers: { "User-Agent": "Mozilla/5.0", "Accept-Language": "en-US,en;q=0.9" },
      signal: AbortSignal.timeout(15000),
    });
    if (res.ok) return await res.text();
  } catch { /* try proxies */ }

  for (const proxy of PROXIES) {
    try {
      const res = await fetch(proxy(url), { signal: AbortSignal.timeout(15000) });
      if (res.ok) return await res.text();
    } catch { continue; }
  }

  throw new Error("All fetch methods failed");
}

// ─────────────────────────────────────────────
//  NEXT.JS ROUTE HANDLER
// ─────────────────────────────────────────────
export async function POST(req: NextRequest) {
  try {
    const { input = "" } = await req.json();
    const trimmed = input.trim();

    if (!trimmed)
      return NextResponse.json({ error: "No input provided" }, { status: 400 });

    let html = trimmed;

    if (trimmed.toLowerCase().startsWith("http")) {
      try {
        html = await fetchUrl(trimmed);
      } catch {
        return NextResponse.json(
          { error: "Unable to fetch URL. Please paste the page content instead." },
          { status: 400 }
        );
      }
    }

    if (html.length < 500)
      return NextResponse.json({ error: "Content too short or invalid" }, { status: 400 });

    const { candidateInfo, questions } = parseJEEHtml(html);

    if (!questions.length)
      return NextResponse.json({ error: "No questions found in HTML" }, { status: 400 });

    const scores = calculateScores(questions);

    return NextResponse.json({
      success:       true,
      candidateName: candidateInfo["Candidate Name"] ?? "",
      applicationNo: candidateInfo["Application No"] ?? "",
      rollNo:        candidateInfo["Roll No."]        ?? "",
      testDate:      candidateInfo["Test Date"]       ?? "",
      ...scores,
    });

  } catch (err) {
    return NextResponse.json({ error: String(err) }, { status: 500 });
  }
}